<?xml version="1.0" encoding="utf-8"?>
<mdscript name="ResearchBlueprintsMod" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <cue name="Main">
      <actions>
        <set_value name="$choices" exact="[]"/>
      </actions>
      <cues>
        <cue name="RBM_Start" instantiate="true">
          <conditions>
            <event_conversation_started conversation="default" actor="md.$PersistentCharacters.$BosoTa"/>
          </conditions>
          <actions>
            <do_if value="@md.ExtendedConversationMenu.Main.exists">
              <set_value name="md.ExtendedConversationMenu.Main.$convOptions.$researchBlueprintsMod" exact="table[ $signalCue = RBM_Main, $params = [] ]"/>
            </do_if>
            <do_else>
              <signal_cue_instantly cue="RBM_Main"/>
            </do_else>
          </actions>
        </cue>
        <cue name="RBM_Main" instantiate="true">
          <conditions>
            <check_any>
              <event_cue_signalled />
              <check_all>
                <event_conversation_returned_to_section section="default" actor="md.$PersistentCharacters.$BosoTa"/>
                <check_value value="@md.ExtendedConversationMenu.Main.exists" negate="true"/>
              </check_all>
            </check_any>
          </conditions>
          <actions>
            <do_if value="@md.ExtendedConversationMenu.Main.exists" negate="true">
              <add_player_choice_return text="{1002,2}" position="bottom_right" comment="Goodbye" returnparam="[true, event.param2]" />
            </do_if>
            <add_player_choice_sub text="'%s %s'.[{1001,97}, {1001,7400}]" section="RBM_Main_Entry" comment="Blueprints research"/>
          </actions>
        </cue>
        <cue name="RBM_Main_Entry_handler" instantiate="true">
          <conditions>
            <check_any>
              <event_conversation_next_section section="RBM_Main_Entry"/>
              <event_conversation_returned_to_section section="RBM_Main_Entry"/>
            </check_any>
          </conditions>
          <actions>
            <add_player_choice_return text="{1001,2669}" position="bottom_right" comment="back"/>
            <add_player_choice_sub text="{1001,9913}" section="RBM_choose_blueprints" comment="choose blueprints" choiceparam="1"/>
            <add_player_choice_sub text="{1001,12}" section="RBM_show_status" comment="status"/>
          </actions>
        </cue>
        <!-- 
          param enum
          1=init
          == init ==
          2=modules
          3=ships
          4=equipment
          == modules ==
          5=productionmodules
          6=buildmodules
          7=storagemodules
          8=habitationmodules
          9=defencemodules
          10=dockmodules
          11=other modules
          == ships ==
          12=XL
          13=L
          14=M
          15=S
          == equipment ==
          16=weapons
          17=rocketlauncher
          18=turret
          19=rocket-turret
          20=enginges
          21=thruster
          22=shield
          23=consumables
        -->
        <cue name="RBM_choose_blueprints_handler" instantiate="true">
          <conditions>
            <check_any>
              <event_conversation_next_section section="RBM_choose_blueprints" />
              <event_conversation_returned_to_section section="RBM_choose_blueprints"/>
              <!-- need to add this, since choosing something from 2nd (or further) page of RBM_fill_menu and then pressing return (6)
                   returns to RBM_fill_menu, bacause the second page is called with a player choice instead of cue signalling, thus
                   the caller of subconversation is RBM_fill_menu so returning from that subconversation returns to RBM_fill_menu
                   so we catch that return event in this cue-->
              <event_conversation_returned_to_section section="RBM_fill_menu"/>
            </check_any>
          </conditions>
          <actions>
            <do_if value="event.param2 == 1"> <!-- init -->
              <set_value name="$choices" exact="[
                table[$text={1001,7924}, $choiceparam=2, $baseparam=event.param2],
                table[$text={1001,6}, $choiceparam=3, $baseparam=event.param2],
                table[$text={1001,7935}, $choiceparam=4, $baseparam=event.param2]
                ]"/> <!-- [modules, ships, equipment]-->
            </do_if>
            <do_elseif value="event.param2 == 2"> <!-- modules -->
              <set_value name="$choices" exact="[
                table[$text={1001,2421}, $choiceparam=5, $baseparam=event.param2],
                table[$text={1001,2439}, $choiceparam=6, $baseparam=event.param2],
                table[$text={1001,2422}, $choiceparam=7, $baseparam=event.param2],
                table[$text={1001,2451}, $choiceparam=8, $baseparam=event.param2],
                table[$text={1001,2424}, $choiceparam=9, $baseparam=event.param2],
                table[$text={1001,2452}, $choiceparam=10, $baseparam=event.param2],
                table[$text={1001,2453}, $choiceparam=11, $baseparam=event.param2]
                ]"/> <!-- production, build, storage, habitation, def, dock, other -->
            </do_elseif>
            <do_elseif value="event.param2 == 3"> <!-- ships -->
              <set_value name="$choices" exact="[
                table[$text={1001,11003}, $choiceparam=12, $baseparam=event.param2],
                table[$text={1001,11002}, $choiceparam=13, $baseparam=event.param2],
                table[$text={1001,11001}, $choiceparam=14, $baseparam=event.param2],
                table[$text={1001,11000}, $choiceparam=15, $baseparam=event.param2]
                ]"/> <!-- XL, L, M, S -->
            </do_elseif>
            <do_elseif value="event.param2 == 4"> <!-- equipment -->
              <set_value name="$choices" exact="[
                table[$text={1001,1105}, $choiceparam=16, $baseparam=event.param2],
                table[$text={1001,1313}, $choiceparam=17, $baseparam=event.param2],
                table[$text={1001,1319}, $choiceparam=18, $baseparam=event.param2],
                table[$text={1001,9031}, $choiceparam=19, $baseparam=event.param2],
                table[$text={1001,1103}, $choiceparam=20, $baseparam=event.param2],
                table[$text={1001,8001}, $choiceparam=21, $baseparam=event.param2],
                table[$text={1001,1317}, $choiceparam=22, $baseparam=event.param2],
                table[$text={1001,8003}, $choiceparam=23, $baseparam=event.param2]
                ]"/> <!-- weapons, rocketlauncher, turret, rocket-turret, engines, thruster, shield, consumables -->
            </do_elseif>
            <do_elseif value="typeof event.param2 == datatype.integer">
              <set_value name="$other" exact="false"/>
              <do_if value="event.param2 le 11">
                <get_ware_definition result="$wares" flags="allowplayerblueprint" tags="tag.module"/>
                <do_if value="event.param2 == 5">
                  <set_value name="$kind" exact="class.production"/>
                </do_if>
                <do_elseif value="event.param2 == 6">
                  <set_value name="$kind" exact="class.buildmodule"/>
                </do_elseif>
                <do_elseif value="event.param2 == 7">
                  <set_value name="$kind" exact="class.storage"/>
                </do_elseif>
                <do_elseif value="event.param2 == 8">
                  <set_value name="$kind" exact="class.habitation"/>
                </do_elseif>
                <do_elseif value="event.param2 == 9">
                  <set_value name="$kind" exact="class.defencemodule"/>
                </do_elseif>
                <do_elseif value="event.param2 == 10">
                  <set_value name="$kind" exact="[class.dockarea, class.pier]"/>
                </do_elseif>
                <do_else> <!-- event.param2 == 11 -->
                  <set_value name="$kind" exact="[class.production, class.buildmodule, class.storage, class.habitation, class.defencemodule, class.dockarea, class.pier]"/>
                  <set_value name="$other" exact="true"/>
                </do_else>
              </do_if>
              <do_elseif value="event.param2 le 15">
                <get_ware_definition result="$wares" flags="allowplayerblueprint" tags="tag.ship"/>
                <do_if value="event.param2 == 12">
                  <set_value name="$kind" exact="class.ship_xl"/>
                </do_if>
                <do_elseif value="event.param2 == 13">
                  <set_value name="$kind" exact="class.ship_l"/>
                </do_elseif>
                <do_elseif value="event.param2 == 14">
                  <set_value name="$kind" exact="class.ship_m"/>
                </do_elseif>
                <do_else> <!-- event.param2 == 15 -->
                  <set_value name="$kind" exact="class.ship_s"/>
                </do_else>
              </do_elseif>
              <do_elseif value="event.param2 le 17">
                <get_ware_definition result="$wares" flags="allowplayerblueprint" tags="tag.weapon"/>
                <do_if value="event.param2 == 16">
                  <set_value name="$kind" exact="class.weapon"/>
                </do_if>
                <do_else> <!-- event.param2 == 17-->
                  <set_value name="$kind" exact="class.missilelauncher"/>
                </do_else>
              </do_elseif>
              <do_elseif value="event.param2 le 19">
                <get_ware_definition result="$wares" flags="allowplayerblueprint" tags="tag.turret"/>
                <do_if value="event.param2 == 18">
                  <set_value name="$kind" exact="class.turret"/>
                </do_if>
                <do_else> <!-- event.param2 == 19-->
                  <set_value name="$kind" exact="class.missileturret"/>
                </do_else>
              </do_elseif>
              <do_elseif value="event.param2 == 20">
                <get_ware_definition result="$wares" flags="allowplayerblueprint" tags="tag.engine"/>
                <set_value name="$kind" exact="class.engine"/>
              </do_elseif>
              <do_elseif value="event.param2 == 21">
                <get_ware_definition result="$wares" flags="allowplayerblueprint" tags="tag.thruster"/>
                <set_value name="$kind" exact="class.engine"/>
              </do_elseif>
              <do_elseif value="event.param2 == 22">
                <get_ware_definition result="$wares" flags="allowplayerblueprint" tags="tag.shield"/>
                <set_value name="$kind" exact="class.shieldgenerator"/>
              </do_elseif>
              <do_else> <!-- event.param2 == 23 -->
                <get_ware_definition result="$wares" flags="allowplayerblueprint" tags="tag.equipment"/>
                <set_value name="$kind" exact="[class.shieldgenerator, class.engine, class.turret, class.missileturret, class.weapon, class.missilelauncher]"/>
                <set_value name="$other" exact="true"/>
              </do_else>
              <set_value name="$choices" exact="[]"/>
              <do_for_each in="$wares" name="$ware">
                <do_if negate="true" value="player.blueprints.{$ware}.any.exists or $ware.hastag.missiononly or $ware.hastag.noblueprint or $ware.hastag.noplayerbuild or $ware.hastag.software or ($ware.objectmacro.isclass.{$kind} == $other)">
                  <append_to_list name="$choices" exact="table[$text=$ware.name, $choiceparam=$ware, $baseparam=event.param2]" />
                </do_if>
              </do_for_each>
            </do_elseif>
            <signal_cue_instantly cue="RBM_fill_menu_handler"/>
          </actions>
        </cue>
        <cue name="RBM_fill_menu_handler" instantiate="true">
          <conditions>
            <check_any>
              <event_cue_signalled />
              <event_conversation_next_section section="RBM_fill_menu" />
            </check_any>
          </conditions>
          <actions>
            <do_if value="event.param2=='next'">
              <set_value name="$page" operation="add"/>
            </do_if>
            <do_elseif value="event.param2=='prev'">
              <set_value name="$page" operation="subtract"/>
            </do_elseif>
            <do_else>
              <set_value name="$page" exact="0"/>
            </do_else>
            <do_if value="$page" negate="true">
              <add_player_choice_return text="{1001,2669}" position="bottom_right" comment="to previous menu back"/>
            </do_if>
            <do_else>
              <add_player_choice text="{1002, 20}" section="RBM_fill_menu" position="bottom_right" choiceparam="'prev'" comment="(back)"/>
            </do_else>
            <do_if value="$choices.count-$page*4 gt 5">
              <add_player_choice text="{1002, 12025}" section="RBM_fill_menu" position="right" choiceparam="'next'" comment="more ..."/>
              <set_value name="$amount" exact="4"/>
            </do_if>
            <do_else>
              <set_value name="$amount" exact="$choices.count-$page*4"/>
            </do_else>
            <do_all exact="$amount" counter="$z">
              <set_value name="$choice" exact="$choices.{$z+$page*4}"/>
              <add_player_choice_sub text="$choice.$text" section="RBM_choose_blueprints" choiceparam="$choice.$choiceparam" baseparam="$choice.$baseparam"/>
            </do_all>
          </actions>
        </cue>
      </cues>
    </cue>
  </cues>
</mdscript>
